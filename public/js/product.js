// const data = {
//     "country": [
//         {
//             "name1": "china",
//             "item": [
//                 {
//                     "name": "bbq chicken heinz",
//                     "price": 599,
//                     "image": "../image/china/bbq chicken better quality.png"
//                 },
//                 {
//                     "name": "bbq original heinz",
//                     "price": 999,
//                     "image": "../image/china/heinz bbq better quality.jpg"
//                 },
//                 {
//                     "name": "light soy sauce heinz",
//                     "price": 199,
//                     "image": "../image/china/heinz light soy sauce Better quality.png"
//                 },
//                 {
//                     "name": "sweet chili heinz",
//                     "price": 199,
//                     "image": "../image/china/heinz sweet chili.png"
//                 },
//                 {
//                     "name": "worchester heinz",
//                     "price": 199,
//                     "image": "../image/china/heinz worchester.jpeg"
//                 },
//                 {
//                     "name": "oyster sauce heinz",
//                     "price": 199,
//                     "image": "../image/china/osyter sauce bad quality.jpg"
//                 }
//             ]
//         },
//         {
//             "name2": "india",
//             "item": [
//                 {
//                     "name": "chicken curry masala",
//                     "price": 599,
//                     "image": "../image/india/chicken curry masala.png"
//                 },
//                 {
//                     "name": "cuncumber",
//                     "price": 999,
//                     "image": "../image/india/cuncumber.jpeg"
//                 },
//                 {
//                     "name": "garlic pasta",
//                     "price": 199,
//                     "image": "../image/india/garlic pasta.png"
//                 },
//                 {
//                     "name": "garlic pickle",
//                     "price": 199,
//                     "image": "../image/india/garlic pickle.png"
//                 },
//                 {
//                     "name": "gulab jamon",
//                     "price": 199,
//                     "image": "../image/india/gulab.png"
//                 },
//                 {
//                     "name": "jalapeno",
//                     "price": 199,
//                     "image": "../image/india/jalapeno.jpeg"
//                 },
//                 {
//                     "name": "jalebi",
//                     "price": 199,
//                     "image": "../image/india/jalebi.png"
//                 },
//                 {
//                     "name": "kashmiri chili powder 200gram",
//                     "price": 199,
//                     "image": "../image/india/kashmiri chili powder better quality.jpg"
//                 },
//                 {
//                     "name": "kashmiri chili 50gram.png",
//                     "price": 199,
//                     "image": "../image/india/kashmiri chili.png"
//                 },
//                 {
//                     "name": "mango pickle",
//                     "price": 199,
//                     "image": "../image/india/mango pickle.jpg"
//                 },
//                 {
//                     "name": "medras curry",
//                     "price": 199,
//                     "image": "../image/india/medras curry powder.jpg"
//                 },
//                 {
//                     "name": "rice dose",
//                     "price": 199,
//                     "image": "../image/india/rice dose.png"
//                 },
//                 {
//                     "name": "rice idli",
//                     "price": 199,
//                     "image": "../image/india/rice idli.png"
//                 },
//                 {
//                     "name": "tandori paste",
//                     "price": 199,
//                     "image": "../image/india/tandori paste .jpg"
//                 },
//                 {
//                     "name": "tandori powder",
//                     "price": 199,
//                     "image": "../image/india/tandori.jpg"
//                 },
//                 {
//                     "name": "udad papad",
//                     "price": 199,
//                     "image": "../image/india/udad padad.jpg"
//                 }
//             ]
//         },
//         {
//             "name3": "italy",
//             "item": [
//                 {
//                     "name": "apple vinger",
//                     "price": 100,
//                     "image": "../image/italy/apple vinger.png"
//                 },
//                 {
//                     "name": "balsamic",
//                     "price": 100,
//                     "image": "../image/italy/balsamic.jpg"
//                 },
//                 {
//                     "name": "white grape organic vinger",
//                     "price": 100,
//                     "image": "../image/italy/grape organic.png"
//                 },
//                 {
//                     "name": "apple vinger organic",
//                     "price": 100,
//                     "image": "../image/italy/organic apple.png"
//                 },
//                 {
//                     "name": "lemon organic vinger",
//                     "price": 100,
//                     "image": "../image/italy/organic lemon.png"
//                 },
//                 {
//                     "name": "red vinger",
//                     "price": 100,
//                     "image": "../image/italy/red vinger.jpg"
//                 },
//                 {
//                     "name": "seasoning for sushi-rice ",
//                     "price": 100,
//                     "image": "../image/italy/suchi-rice.png"
//                 },
//                 {
//                     "name": "black beans",
//                     "price": 100,
//                     "image": "../image/italy/black beans.png"
//                 },
//                 {
//                     "name": "cannellni beans",
//                     "price": 100,
//                     "image": "../image/italy/can.png"
//                 },
//                 {
//                     "name": "peeled tomato",
//                     "price": 100,
//                     "image": "../image/italy/tomato.png"
//                 },
//                 {
//                     "name": "napoletta",
//                     "price": 100,
//                     "image": "../image/italy/napoletta.png"
//                 },
//                 {
//                     "name": "panne attima",
//                     "price": 100,
//                     "image": "../image/italy/ottima penne .png"
//                 },
//                 {
//                     "name": "spagetti ottima",
//                     "price": 100,
//                     "image": "../image/italy/ottima spagheti.png"
//                 },
//                 {
//                     "name": "lumachine 8 ottima",
//                     "price": 100,
//                     "image": "../image/italy/pasta.png"
//                 },
//                 {
//                     "name": "pomodori ottima",
//                     "price": 100,
//                     "image": "../image/italy/ottima pomodoriiii.png"
//                 }, {
//                     "name": "pesto",
//                     "price": 100,
//                     "image": "../image/italy/pesto.png"
//                 }, {
//                     "name": "quinoa",
//                     "price": 100,
//                     "image": "../image/italy/quinoa.png"
//                 }, {
//                     "name": "quonina risovi",
//                     "price": 100,
//                     "image": "../image/italy/risovi quoinaa rosaa.png"
//                 }, {
//                     "name": "sushi premium risovi",
//                     "price": 100,
//                     "image": "../image/italy/risovi sushi premium.png"
//                 },
//                 {
//                     "name": "riso arborio",
//                     "price": 100,
//                     "image": "../image/italy/riso arborio.png"
//                 }
//             ]
//         },
//         {
//             "name4": "spain",
//             "item": [
//                 {
//                     "name": "extra virgin olive 1 litre la pedriza",
//                     "price": 599,
//                     "image": "../image/spain/la pedrizaa extra virgin .png"
//                 },
//                 {
//                     "name": "extra virgin olive la pedriza half litre",
//                     "price": 999,
//                     "image": "../image/spain/extra virgin olive oil.jpg"
//                 },
//                 {
//                     "name": "virgin olive oil 1 litre la pedriza",
//                     "price": 199,
//                     "image": "../image/spain/virgin olive oil 1 liter.jpg"
//                 },
//                 {
//                     "name": "green pepper la pedriza",
//                     "price": 199,
//                     "image": "../image/spain/green peppers.png"
//                 },
//                 {
//                     "name": "capers 100g la pedroza",
//                     "price": 199,
//                     "image": "../image/spain/cappers.png"
//                 },
//                 {
//                     "name": "capers 720g la padriza",
//                     "price": 199,
//                     "image": "../image/spain/la padriza caper 720 g better.png"
//                 }
//             ]
//         },
//         {
//             "name5": "tunis",
//             "item": [
//                 {
//                     "name": "couscous 1kg",
//                     "price": 599,
//                     "image": "../image/tunis/diary.png"
//                 },
//                 {
//                     "name": "spaghetti 2 spiga",
//                     "price": 999,
//                     "image": "../image/tunis/Spaghetti 2.jpg"
//                 },
//                 {
//                     "name": "spiga coude 2 spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA COUDE ANOTHER.webp"
//                 },
//                 {
//                     "name": "escarget spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA ESCARGET.jpg"
//                 },
//                 {
//                     "name": "fell 2 spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA FELL 2.jpg"
//                 },
//                 {
//                     "name": "fell 3 spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA FELL 3.jpg"
//                 },
//                 {
//                     "name": "lasagne spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA lasagne-500g.jpg"
//                 },
//                 {
//                     "name": "plime 2 spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA PLIME.jpg"
//                 },
//                 {
//                     "name": "spirals spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA SPIRALS.jpg"
//                 },
//                 {
//                     "name": "tagiatlee spiga",
//                     "price": 199,
//                     "image": "../image/tunis/SPIGA TAGIATLEE.jpg"
//                 }
//             ]
//         },
//         {
//             "name6": "thiland",
//             "item": [
//                 {
//                     "name": "concunut milk 1 litre",
//                     "price": 100,
//                     "image": "../image/thialnd/aroy d cocunut milk.jpg"
//                 },
//                 {
//                     "name": "baby corn",
//                     "price": 100,
//                     "image": "../image/thialnd/baby corn.png"
//                 },
//                 {
//                     "name": "bambo shoot",
//                     "price": 100,
//                     "image": "../image/thialnd/bamboo.png"
//                 },
//                 {
//                     "name": "bean sproutgs queen",
//                     "price": 100,
//                     "image": "../image/thialnd/bean sproutgs.png"
//                 },
//                 {
//                     "name": "bean sproutga sherry",
//                     "price": 100,
//                     "image": "../image/thialnd/bean.png"
//                 },
//                 {
//                     "name": "boba ",
//                     "price": 100,
//                     "image": "../image/thialnd/boba.jpg"
//                 },
//                 {
//                     "name": "concunut milk green garden",
//                     "price": 100,
//                     "image": "../image/thialnd/coconut milk.png"
//                 },
//                 {
//                     "name": "conconut cream queen",
//                     "price": 100,
//                     "image": "../image/thialnd/conconut cream.png"
//                 },
//                 {
//                     "name": "dark soy sauce ",
//                     "price": 100,
//                     "image": "../image/thialnd/dark soya sauce.png"
//                 },
//                 {
//                     "name": "light soy ",
//                     "price": 100,
//                     "image": "../image/thialnd/light soy.png"
//                 },
//                 {
//                     "name": "green curry",
//                     "price": 100,
//                     "image": "../image/thialnd/green curry.png"
//                 },
//                 {
//                     "name": "hoisin makin",
//                     "price": 100,
//                     "image": "../image/thialnd/makin hoisin.jpg"
//                 },
//                 {
//                     "name": "matcha",
//                     "price": 100,
//                     "image": "../image/thialnd/matcha.jpg"
//                 },
//                 {
//                     "name": "mushroom sherry",
//                     "price": 100,
//                     "image": "../image/thialnd/mushroom.png"
//                 },
//                 {
//                     "name": "pinapple green garden",
//                     "price": 100,
//                     "image": "../image/thialnd/pinapple.png"
//                 },
//                 {
//                     "name": "coconut milk queen ",
//                     "price": 100,
//                     "image": "../image/thialnd/quenn coocunut milk.jpg"
//                 },
//                 {
//                     "name": "red curry",
//                     "price": 100,
//                     "image": "../image/thialnd/red curry.png"
//                 },
//                 {
//                     "name": "saracha hot sauce",
//                     "price": 100,
//                     "image": "../image/thialnd/saracha.png"
//                 },
//                 {
//                     "name": "sweet chili makin",
//                     "price": 100,
//                     "image": "../image/thialnd/sweet chili.jpg"
//                 },
//                 {
//                     "name": "sweet chili diamond",
//                     "price": 100,
//                     "image": "../image/thialnd/sweet chili.png"
//                 },
//                 {
//                     "name": "sweet corn ",
//                     "price": 100,
//                     "image": "../image/thialnd/sweet corn.png"
//                 },
//                 {
//                     "name": "sweet corn green garden",
//                     "price": 100,
//                     "image": "../image/thialnd/sweet corn.png"
//                 },
//                 {
//                     "name": "taro",
//                     "price": 100,
//                     "image": "../image/thialnd/taro.png"
//                 },
//                 {
//                     "name": "tomyum paste",
//                     "price": 100,
//                     "image": "../image/thialnd/tomyum.png"
//                 }
//             ]
//         }
//     ]
// };

const container = document.getElementById('container');
const page = document.getElementById('page');
const backbtn = document.getElementById('backbtn');
const checkoutBtn = document.getElementById('checkoutBtn');
const addToCartBtn = document.getElementById('addToCartBtn');
const cartContainer = document.getElementById('cartContainer');
const searchInput = document.getElementById('searchInput');

let totalSum = 0;
let cart = {};

// âœ… Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„ Ù…Ù†ØªØ¬
document.querySelectorAll('.item').forEach(div => {
  let quantity = 0;

  const incButton = div.querySelector('.incbtn');
  const decButton = div.querySelector('.decbtn');
  const countSpan = div.querySelector('.cont');

  const name = div.querySelector('.item-details strong').textContent;
  const priceText = div.querySelector('.item-details p').textContent;
  const price = Number(priceText.replace('Price: ', '').trim());
  const image = div.querySelector('img').src;

  incButton.addEventListener('click', async () => {
    quantity++;
    countSpan.textContent = quantity;

    cart[name] = {
      price,
      quantity,
      image
    };
    await syncCartToServer();
  });

  decButton.addEventListener('click', async () => {
    if (quantity > 0) {
      quantity--;
      countSpan.textContent = quantity;

      if (quantity === 0) {
        delete cart[name];
      } else {
        cart[name] = {
          price,
          quantity,
          image
        };
      }
      await syncCartToServer();
    }
  });
});

// âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¯ÙˆÙ„Ø©
searchInput.addEventListener('input', function () {
  const query = this.value.toLowerCase();
  document.querySelectorAll('.item').forEach(div => {
    const name = div.querySelector('.item-details strong').textContent.toLowerCase();
    const country = div.querySelector('.item-details p:nth-child(3)').textContent.toLowerCase();

    const match = name.includes(query) || country.includes(query);
    div.style.display = match ? 'flex' : 'none';
  });
});

// âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ù„Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±
async function syncCartToServer() {
  try {
    await fetch('/api/update-cart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cart })
    });
    console.log('ðŸ›’ Cart synced to server:', cart);
  } catch (error) {
    console.error('Failed to sync cart:', error);
  }
}

// âœ… Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
addToCartBtn.addEventListener('click', () => {
  backbtn.style.display = 'block';
  addToCartBtn.style.display = 'none';
  document.querySelector('.search-bar-container').style.display = 'none';
  container.style.display = 'none';
  page.style.display = 'block';

  cartContainer.innerHTML = '';
  const orderBlock = document.createElement('div');
  orderBlock.id = 'orderblock';

  let hasItems = false;
  totalSum = 0;

  for (let itemName in cart) {
    const item = cart[itemName];
    if (item.quantity > 0) {
      hasItems = true;
      totalSum += item.price * item.quantity;

      const order = document.createElement('div');
      order.classList.add('orderItem');

      order.innerHTML = `
        <img src="${item.image}" alt="${itemName}">
        <div>
          <strong>${itemName}</strong><br>
          Price: ${item.price}<br>
          Quantity: ${item.quantity}<br>
          Total: ${item.price * item.quantity}<br>
        </div>
      `;

      orderBlock.appendChild(order);
    }
  }

  if (hasItems) {
    const totalDiv = document.createElement('div');
    totalDiv.classList.add('totall');
    totalDiv.textContent = `Total amount: ${totalSum}`;
    orderBlock.appendChild(totalDiv);
    cartContainer.appendChild(orderBlock);
    checkoutBtn.style.display = 'block';
  } else {
    cartContainer.innerHTML = '<p>Your cart is empty</p>';
    checkoutBtn.style.display = 'none';
  }
});

// âœ… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
backbtn.addEventListener('click', () => {
  container.style.display = 'flex';
  backbtn.style.display = 'none';
  page.style.display = 'none';
  addToCartBtn.style.display = 'block';
  document.querySelector('.search-bar-container').style.display = 'block';
  document.querySelector('.search-bar-container').style.display = 'flex'
});

// âœ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹
checkoutBtn.addEventListener('click', () => {
  window.location.href = '/payment';
});

 const source = new EventSource('/events');
  source.onmessage = function (event) {
    if (event.data === 'refresh-products') {
      location.reload(); // Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… fetch() Ù„Ùˆ Ø¨ØªØ­Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠÙƒÙˆÙ† Ø£Ù†Ø¹Ù…
    }
  };